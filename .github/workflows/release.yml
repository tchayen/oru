name: Release

on:
  release:
    types: [published]

jobs:
  build:
    strategy:
      matrix:
        include:
          - runner: macos-14
            platform: darwin-arm64
          - runner: ubuntu-latest
            platform: linux-x64
          - runner: ubuntu-24.04-arm
            platform: linux-arm64

    runs-on: ${{ matrix.runner }}

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Verify tag matches package.json
        env:
          TAG: ${{ github.event.release.tag_name }}
        run: |
          VERSION="${TAG#v}"
          PKG_VERSION=$(node -p "require('./cli/package.json').version")
          if [ "$VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Tag ($VERSION) does not match cli/package.json ($PKG_VERSION)"
            exit 1
          fi

      - run: pnpm --filter @tchayen/oru build

      - name: Create production deployment
        run: |
          mkdir -p cli/staging
          pnpm --filter @tchayen/oru --config.inject-workspace-packages=true deploy --prod cli/staging

      - name: Package tarball
        working-directory: cli
        env:
          TAG: ${{ github.event.release.tag_name }}
        run: |
          VERSION="${TAG#v}"
          TARBALL_DIR="oru-v${VERSION}-${{ matrix.platform }}"
          mkdir -p "$TARBALL_DIR"

          cp -r staging/dist "$TARBALL_DIR/"
          cp -r staging/node_modules "$TARBALL_DIR/"
          cp staging/package.json "$TARBALL_DIR/"

          cat > "$TARBALL_DIR/oru" <<'WRAPPER'
          #!/bin/sh
          exec node "$(dirname "$0")/dist/cli.js" "$@"
          WRAPPER
          chmod +x "$TARBALL_DIR/oru"

          tar -czf "$TARBALL_DIR.tar.gz" "$TARBALL_DIR"

      - uses: actions/upload-artifact@v4
        with:
          name: oru-${{ matrix.platform }}
          path: cli/oru-v*-${{ matrix.platform }}.tar.gz

  publish-npm:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
          registry-url: https://registry.npmjs.org

      - run: pnpm install --frozen-lockfile

      - name: Verify tag matches package.json
        env:
          TAG: ${{ github.event.release.tag_name }}
        run: |
          VERSION="${TAG#v}"
          PKG_VERSION=$(node -p "require('./cli/package.json').version")
          if [ "$VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Tag ($VERSION) does not match cli/package.json ($PKG_VERSION)"
            exit 1
          fi

      - run: pnpm --filter @tchayen/oru build
      - run: pnpm --filter @tchayen/oru publish --provenance --no-git-checks

  publish-gpr:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          registry-url: https://npm.pkg.github.com
          scope: "@tchayen"

      - run: pnpm install --frozen-lockfile

      - name: Verify tag matches package.json
        env:
          TAG: ${{ github.event.release.tag_name }}
        run: |
          VERSION="${TAG#v}"
          PKG_VERSION=$(node -p "require('./cli/package.json').version")
          if [ "$VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Tag ($VERSION) does not match cli/package.json ($PKG_VERSION)"
            exit 1
          fi

      - run: pnpm --filter @tchayen/oru build
      - run: pnpm --filter @tchayen/oru publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  upload-assets:
    needs: [build, publish-npm, publish-gpr]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --latest --strip header
        env:
          OUTPUT: CHANGELOG.md
          GITHUB_TOKEN: ${{ github.token }}

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Update release with changelog and assets
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ github.event.release.tag_name }}
        run: |
          gh release edit "$TAG" --notes-file CHANGELOG.md
          gh release upload "$TAG" artifacts/*.tar.gz --clobber
